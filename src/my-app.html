<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link ref="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link ref="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/prism-pagination/prism-pagination.html">
<link rel="import" href="../bower_components/prism-pagination/prism-square-pager.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-button.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-checkbox.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../bower_components/vaadin-radio-button/vaadin-radio-button.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/scary-cookie/scary-cookie.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="external-lib-imports.html">
<link rel="import" href="utils/pretty-number.html">
<link rel="import" href="utils/time-str.html">
<link rel="import" href="utils/global-variable.html">
<link rel="import" href="utils/notification-panel.html">
<link rel="import" href="utils/market-selector.html">
<link rel="import" href="utils/address-text-field.html">
<link rel="import" href="utils/loopr-ajax.html">
<link rel="import" href="loopr-page/looper-toolbar.html">
<link rel="import" href="loopr-page/looper-footer.html">
<link rel="import" href="loopr-page/simple-toolbar.html">
<link rel="import" href="loopr-page/looper-page.html">
<link rel="import" href="loopr-page/ethereum-signer.html">
<link rel="import" href="loopr-page/signtosend-dialog.html">
<link rel="import" href="page-markets.html">
<link rel="import" href="page-settings.html">
<link rel="import" href="page-wallet.html">
<link rel="import" href="page-history.html">
<link rel="lazy-import" href="page-market.html">
<link rel="lazy-import" href="page-ring.html">
<link rel="lazy-import" href="page-order.html">
<link rel="lazy-import" href="page-transfer.html">
<link rel="lazy-import" href="page-approve.html">
<link rel="lazy-import" href="page-convert.html">
<link rel="lazy-import" href="page-doc.html">
<link rel="lazy-import" href="page-404.html">
<link rel="lazy-import" href="page-dev.html">
<link rel="lazy-import" href="page-generatewallet.html">
<link rel="lazy-import" href="page-unlockwallet.html">
<dom-module id="my-app">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
     :host {
            --app-primary-color: var(--paper-blue-500);
            --app-primary-color-dark: var(--paper-blue-700);
            --app-secondary-color: black;
            --paper-spinner-color: var(--app-primary-color);
            --paper-spinner-stroke-width: 1px;
            --app-red-color: var(--paper-red-500);
            --app-green-color: var(--paper-green-500);
            --app-text-color: rgba(0, 0, 0, .78);
            --app-text-color-light: rgba(0, 0, 0, .54);

            --valo-border-radius: 0px;
            --valo-primary-text-color: var(--app-text-color);
            --valo-body-text-color: var(--app-text-color);
            --valo-contrast-60pct: var(--app-text-color-light);
            --valo-error-color: var(--paper-red-500);
            --vaadin-grid-header-cell: {
                text-transform: uppercase;
            }
            --paper-tabs-selection-bar-color: var(--app-primary-color);
            --paper-tab-ink: transparent;
            --paper-tab-content: {
                color: var(--app-primary-color);
            }
            --paper-tab-content-unselected: {
                color: var(--app-text-color);
            }
        }

        display: block;
    }

    app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
    }

    app-header {
        color: #fff;
        /*height: 96px;*/

        background-color: var(--app-primary-color-dark);
    }

    app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
    }

    a[styleless] {
        color: inherit;
        text-decoration: none;
    }

    .drawer-list {
        margin: 0 20px;
    }

    .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
    }

    .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
    }

    #pages {
        display: none;
    }

    #loading {
        padding-top: 30vh;
        color: var(--app-primary-color);
        font-weight: 200;
    }

    #loading paper-spinner-lite {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
    }

    #loading iron-icon {
        position: relative;
        width: 40px;
        height: 40px;
        top: 60px;
    }

    #lockButton.openned {
        background-color: var(--paper-amber-700);
        color: white;
        border-radius: 50%;
    }

    paper-icon-button:not([narrow]) [drawer-toggle] {
        display: none;
    }

    app-toolbar iron-image {
        width: 140px;
        height: 32px;
    }

    div.address {
        font-size: 12px;
        padding-right: 8px;
    }
        </style>
        <!-- routing -->
        <app-location use-hash-as-path route="{{route}}">
        </app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}">
        </app-route>
        <app-route route="{{subroute}}" pattern="/:pageId" data="{{subrouteData}}">
        </app-route>
        <!-- hidden components -->
        <signtosend-dialog id="signtosend"></signtosend-dialog>
        <notification-panel id="notification"></notification-panel>
        <!-- ajax -->
        <iron-ajax auto url="https://raw.githubusercontent.com/Loopring/mock-relay-data/master/config.json" handle-as="json" last-response="{{appConfigRaw}}"></iron-ajax>
        <!--<iron-ajax auto id="priceQuoteAjax" url="[[settingsRelay]]/Loopring/mock-relay-data/master/price-quote.json?currency=[[settingsCurrency]]&[[priceTimestamp]]" handle-as="json" last-response="{{priceQuoteRaw}}"></iron-ajax>-->
        <loopr-ajax id="priceQuoteAjax" relay="[[settingsRelay]]" suffix="Loopring/mock-relay-data/master/price-quote.json?currency=[[settingsCurrency]]&[[priceTimestamp]]" last-response="{{priceQuoteRaw}}"></loopr-ajax>
        <!-- global vars -->
        <global-variable key="app-config" value="{{appConfig}}"></global-variable>
        <global-variable key="token-price" value="{{priceQuote}}"></global-variable>
        <global-variable key="wallet" value="{{wallet}}"></global-variable>
        <global-variable key="settings-lang" value="{{settingsLang}}"></global-variable>
        <global-variable key="settings-currency" value="{{settingsCurrency}}"></global-variable>
        <global-variable key="settings-lrcFee" value="{{settingsLrcFee}}"></global-variable>
        <global-variable key="settings-relay" value="{{settingsRelay}}"></global-variable>
        <global-variable key="settings-gasPrice" value="{{settingsGasPrice}}"></global-variable>
        <global-variable key="settings-version" value="{{settingsVersion}}"></global-variable>
        <global-variable key="settings-marginSplit" value="{{settingsMarginSplit}}"></global-variable>
        <scary-cookie id="settingsLang" name="settings-lang" value="{{settingsLang}}"></scary-cookie>
        <scary-cookie id="settingsCurrency" name="settings-currency" value="{{settingsCurrency}}"></scary-cookie>
        <scary-cookie id="settingsLrcFee" name="settings-lrcFee" value="{{settingsLrcFee}}"></scary-cookie>
        <scary-cookie id="settingsRelay" name="settings-relay" value="{{settingsRelay}}"></scary-cookie>
        <scary-cookie id="settingsGasPrice" name="settings-gasPrice" value="{{settingsGasPrice}}"></scary-cookie>
        <scary-cookie id="settingsVersion" name="settings-version" value="{{settingsVersion}}"></scary-cookie>
        <scary-cookie id="warnedVersion" name="warned-version" value="{{warnedVersion}}"></scary-cookie>
        <scary-cookie id="settingsMarginSplit" name="settings-marginSplit" value="{{settingsMarginSplit}}"></scary-cookie>
        <!-- main layout -->
        <app-drawer-layout fullbleed force-narrow>
            <app-drawer no-focus-trap slot="drawer">
                <a name="markets" href="#/markets">
                    <paper-item>Item 1</paper-item>
                </a>
                <a name="wallet" href="#/wallet">
                    <paper-item>Item 2</paper-item>
                </a>
            </app-drawer>
            <app-header-layout has-scrolling-region fullbleed>
                <app-header fixed slot="header" id="appHeader">
                    <app-toolbar>
                        <!-- <paper-icon-button icon="menu" drawer-toggle></paper-icon-button> -->
                        <!-- <div spacer></div> -->
                        <a styleless href="/#/">
                            <div main-title><iron-image src="images/logo_white.png" sizing="contain"></iron-image></div>
                        </a>
                        <div condensed-title></div>
                        <div class="address">[[wallet.address]]</div>
                        <paper-icon-button id="lockButton" noink class$="[[lockClass]]" on-click="_lockButtonClick" icon="lock" tabindex="-1"></paper-icon-button>
                        <!-- <div spacer></div> -->
                    </app-toolbar>
                </app-header>
                <div id="loading" class="vertical layout center center-justified">
                    <iron-icon id="loading-icon" icon="menu"></iron-icon>
                    <paper-spinner-lite alt="Loading configuration..." active class="thick"></paper-spinner-lite>
                    <div>Loading configuration...</div>
                </div>
                <iron-pages id="pages" selected="[[page]]" attr-for-selected="name" selected-item="{{selectedPage}}" fallback-selection="404" role="main">
                    <page-market name="market" id={{pageId}}></page-market>
                    <page-markets name="markets"></page-markets>
                    <page-wallet id="walletPage" name="wallet" secondary-page={{pageId}}></page-wallet>
                    <page-ring name="ring" id={{pageId}}></page-ring>
                    <page-order name="order" id={{pageId}}></page-order>
                    <page-history name="history" subpage={{pageId}}></page-history>
                    <page-convert name="convert" fromToken={{pageId}}></page-convert>
                    <page-approve name="approve" token={{pageId}}></page-approve>
                    <page-transfer name="transfer" token={{pageId}}></page-transfer>
                    <page-settings name="settings"></page-settings>
                    <page-unlockwallet name="unlockwallet"></page-unlockwallet>
                    <page-generatewallet name="generatewallet"></page-generatewallet>
                    <page-doc name="doc" page-id={{pageId}}></page-doc>
                    <page-dev name="dev"></page-dev>
                    <page-404 name="404"></page-404>
                </iron-pages>
            </app-header-layout>
        </app-drawer-layout>
    </template>
    <script>
    const keystore = require('keystore');
    const privateKeyWallet = require('privateKey');
    const Validator = require('validator');
    const ethUtil = require('ethereumjs-util');
    const Relay = require('relay');
    const Order = require('order');

    class MyApp extends Polymer.Element {
        static get is() {
            return 'my-app';
        }

        static get properties() {
            return {
                cookieValues: {
                    type: Object
                },
                settingsLang: {
                    type: String,
                    computed: '_computedLang(appConfig, cookieValues)'
                },
                settingsCurrency: {
                    type: String,
                    computed: '_computedCurrency(appConfig, cookieValues)'
                },
                settingsRelay: {
                    type: String,
                    computed: '_computedRelay(appConfig, cookieValues)'
                },
                settingsLrcFee: {
                    type: Number,
                    computed: '_computedLrcFee(appConfig, cookieValues)'
                },
                settingsGasPrice: {
                    type: Number,
                    computed: '_computedGasPrice(appConfig, cookieValues)'
                },
                settingsVersion: {
                    type: Number,
                    computed: '_computedVersion(appConfig, cookieValues)'
                },
                settingsMarginSplit: {
                    type: Number,
                    computed: '_computedMarginSplit(appConfig, cookieValues)'
                },
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                },
                pageId: {
                    type: String,
                    reflectToAttribute: true
                },
                routeData: Object,
                rootPath: String,
                subrouteData: Object,
                appConfigRaw: Object,
                appConfig: {
                    type: Object,
                    computed: '_computeAppConfig(appConfigRaw)'
                },
                priceQuoteRaw: Object,
                priceQuote: {
                    type: Object,
                    computed: '_computePriceQuote(priceQuoteRaw)'
                },
                wallet: {
                    type: Object,
                    observer: '_walletChanged'
                },
                selectedPage: {
                    type: Object,
                    observer: '_selectedPageChanged'
                },
                priceTimestamp: {
                    type: String
                }
            };
        }

        ready() {
            super.ready();
            let cookieValue = {};
            if (this.$.settingsRelay.value) {
                cookieValue["settingsRelay"] = this.$.settingsRelay.value;
            }
            if (this.$.settingsCurrency.value) {
                cookieValue["settingsCurrency"] = this.$.settingsCurrency.value;
            }
            if (this.$.settingsLang.value) {
                cookieValue["settingsLang"] = this.$.settingsLang.value;
            }
            if (this.$.settingsLrcFee.value) {
                cookieValue["settingsLrcFee"] = this.$.settingsLrcFee.value;
            }
            if (this.$.settingsGasPrice.value) {
                cookieValue["settingsGasPrice"] = this.$.settingsGasPrice.value;
            }
            if (this.$.settingsVersion.value) {
                cookieValue["settingsVersion"] = this.$.settingsVersion.value;
            }
            if (this.$.warnedVersion.value) {
                cookieValue["warnedVersion"] = this.$.warnedVersion.value;
            }
            if (this.$.settingsMarginSplit.value) {
                cookieValue["settingsMarginSplit"] = this.$.settingsMarginSplit.value;
            }
            this.cookieValues = cookieValue;

            this.addEventListener('notification', e => this.$.notification.display(e.detail));
            this.addEventListener('signtosend', e => this.$.signtosend.show(e.detail));
            this.addEventListener('reset-wallet', e => this._resetWallet());
            this.addEventListener('nout-found', e => this._showPage404(e.detail));

            let _this = this;
            window.setInterval(function() {
                _this.priceTimestamp = Date.parse(new Date());
            }, 600000);

            Array.prototype.forEach.call(this.root.querySelectorAll('a'), (item) => {
                item.tabIndex = "-1";
            });
        }

        _ifLoadAjax(settingsRelay, settingsCurrency){
            return settingsRelay && settingsCurrency;
        }

        _computedLang(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsLang"]) {
                    return cookieValues["settingsLang"];
                } else {
                    return appConfig.langs[0].value;
                }
            }
        }

        _computedCurrency(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsCurrency"]) {
                    return cookieValues["settingsCurrency"];
                } else {
                    return appConfig.fiat[0].value;
                }
            }
        }

        _computedRelay(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsRelay"]) {
                    return cookieValues["settingsRelay"];
                } else {
                    return appConfig.relays[0].value;
                }
            }
        }

        _computedLrcFee(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsLrcFee"]) {
                    return cookieValues["settingsLrcFee"];
                } else {
                    return appConfig.defaultLrcFeePermillage;
                }
            }
        }

        _computedGasPrice(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsGasPrice"]) {
                    return cookieValues["settingsGasPrice"]
                } else {
                    return appConfig.defaultGasPrice;
                }
            }
        }

        _computedVersion(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                let latestVersion = appConfig.contracts[appConfig.contracts.length - 1].version;
                if (cookieValues["settingsVersion"]) {
                    let currentVersion = cookieValues["settingsVersion"];
                    let warnedVersion = cookieValues["warnedVersion"];
                    if (latestVersion != currentVersion) {
                        if (!warnedVersion || warnedVersion != latestVersion) {
                            var detail = {
                                text: "Your current contract version is " + currentVersion + ", latest version " + latestVersion + " is available",
                                category: "warning",
                                duration: 8000
                            }
                            this.dispatchEvent(new CustomEvent('notification', {
                                bubbles: true,
                                composed: true,
                                detail: detail
                            }));
                            this.warnedVersion = latestVersion;
                        }
                    }
                    return currentVersion;
                } else {
                    return latestVersion;
                }
            }
        }

        _computedMarginSplit(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                if (cookieValues["settingsMarginSplit"]) {
                    return cookieValues["settingsMarginSplit"];
                } else {
                    return appConfig.defaultMarginSplitPercentage;
                }
            }
        }

        _computeAppConfig(appConfigRaw) {
            if (appConfigRaw) {
                var appConfig = appConfigRaw;
                appConfig.computeMarketId = function(tokenx, tokeny) {
                    return tokenx + "-" + tokeny;
                }

                appConfig.tokenMap = _.keyBy(appConfigRaw.tokens, o => o.token);
                appConfig.lrc = appConfig.tokenMap["LRC"];
                appConfig.tokenAddressMap = _.keyBy(appConfigRaw.tokens, o => o.address);
                appConfig.tokenIds = _.map(appConfigRaw.tokens, o => o.token);
                appConfig.marketMap = _.keyBy(appConfigRaw.markets, o => appConfig.computeMarketId(o.tokenx, o.tokeny));
                appConfig.marketIds = _.map(appConfigRaw.markets, o => appConfig.computeMarketId(o.tokenx, o.tokeny));
                appConfig.marketConfig = { defaultPricePrecision: 3, defaultVolumePrecision: 5 }
                appConfig.contractVersionMap = _.keyBy(appConfigRaw.contracts, o => o.version);

                this.$.loading.style.display = "none";
                this.$.pages.style.display = "inherit";
                return appConfig;
            }
        }

        _computePriceQuote(priceQuoteRaw) {
            if (priceQuoteRaw !== null) {
                var priceQuote = priceQuoteRaw.result;
                priceQuote.priceMap = _.keyBy(priceQuote.tokens, o => o.token);
                priceQuote.getPrice = function(token) {
                    const t = priceQuote.priceMap[token];
                    if (t) return t.price;
                    else return 0;
                }

                return priceQuote;
            }
        }

        _resetWallet() {
            console.log("reset wallet");
            this.wallet = null;
            window.location = "/#/wallet/assets";
        }

        _walletChanged(wallet) {
            if (wallet) {
                this.$.walletPage.subpage = "ready";
                if (this.page !== "wallet") {
                    window.location = "/#/wallet";
                }
            } else {
                this.$.walletPage.subpage = "default";
            }
        }

        static get observers() {
            return [
                '_routePageChanged(routeData.page)',
                '_routeIdChanged(subrouteData.pageId)',
                'isUnlocked(wallet)'
            ];
        }

        _lockButtonClick() {
            if (this.wallet) {
                this.wallet = null
            } else {
                window.location = "/#/wallet";
            }
        }

        _routePageChanged(page) {
            this.page = page || 'markets';
        }

        _pageChanged(page) {
            const resolvedPageUrl = this.resolveUrl('page-' + page + '.html');
            Polymer.importHref(
                resolvedPageUrl,
                null,
                this._showPage404.bind(this),
                true);
        }

        _selectedPageChanged(page) {
            if (page && page.go) page.go();
        }

        _routeIdChanged(pageId) {
            this.pageId = pageId || '';
        }


        _showPage404(errorMsg) {
            this.page = '404';
        }

        isUnlocked(wallet) {
            if (!wallet) {
                this.$.lockButton.icon = 'lock';
                this.lockClass = '';
            } else {
                this.$.lockButton.icon = "lock-open";
                this.lockClass = "openned";
            }
        }

    }

    window.customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>